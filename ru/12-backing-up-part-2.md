Резервное копирование - Часть II
================================

Norman Dunbar

Уровень сложности: Средний.


* * *

В первой части я рассказывал, как сделать резервную копию SD карты вашего Raspberry Pi. Во второй части я продемонстрирую как проверить работоспособность резервной копии. Так же я покажу вам "хитрость", с помощью которой вы сможете работать с образом резервной копии, как с обычным диском. Вы узнаете как редактировать файлы прямо в образе резервной копии. И когда, в дальнейшем, вы запишите образ на SD карту, все сделанные изменения останутся.

Напомню, что все это легко выполнимо в Linux,однако для пользователей Windows всё не так просто. Пользователям Windows следует подумать о Live CD с Linux или об установке Linux на виртуальную машину, например VirtualBox.


Проверка целостности резервной копии
------------------------------------
Сделать резервную копию - несложная задача, но важно убедиться, что данные переписались правильно. Будет не весело, когда SD карта в Raspberry Pi испортилась, а резервная копия оказалась нерабочей. Прийдется устанавливать и настраивать систему и все программы заново. И конечно же, данные будут потеряны безвозвратно. Так что, проверять резервный копии - это очень важно.

Самый простой способ - записать образ на другую SD карту и попробовать её в Raspberry Pi. Это быстро, просто, и мы так уже делали - см. часть I в предыдущем выпуске журнала.

В это статье описан способ, который позволит вам работать с образом, как с обычным устройством, например с SD картой.

Учтите, все описанное дальше подразумевает,что образ разархивирован и находится на локальном жестком диске. Если ваш образ сжатый, распакуйте его и начнем.

Итак, первое что нужно сделать, это определить начало раздела. Так как у нас есть образ SD карты, мы можем просмотреть его содержимое, и увидеть таблицу разделов.

Если хотите, можете выполнять все действия от пользователя Pi, тогда начинайте каждую команду c 'sudo'. Но, можно сделать проще, и получить root права командой:

    $ sudo sh

Эта команда запустить оболочку пользователя root и избавит вас от необходимости каждый раз водить sudo перед командами.

Первым делом нам нужно определить границы разделов и размеры секторов. Fdisk выводит размеры в секторах, но для удобства отображает и объем сектора.

Команда для вывода информации о разделе:

    $ fdisk Rpi_8gb_backup.img


    Welcome to fdisk (util-linux 2.21.2).
    ...
    Command (m for help): p
    Disk Rpi_8gb_backup.img: 7948 MB, 7948206080 bytes
    255 heads, 63 sectors/track, 966 cylinders, total 15523840 sectors
    Units = sectors of 1 * 512 = 512 bytes
    Sector size (logical/physical): 512 bytes / 512 bytes
    I/O size (minimum/optimal): 512 bytes / 512 bytes
    Disk identifier: 0x000dbfc6
    Device Boot Start End Blocks Id System
    /BU/Rpi_8gb_backup. img1 8192 122879 57344 c W95 FAT32 (LBA)
    /BU/Rpi_8gb_backup. img2 122880 15523839 7700480 83 Linux

После запуска утилиты fdisk введите команду 'p' для вывода таблицы разделов. Эта команда выводит подробную информацию о текущих разделах, их расположение и размер.

В строчках которые начинаются с 'Units' или 'Sector size' мы видим что размер сектора - 512 байт. А наши два раздела начинаются с секторов 8192 и 122880. Умножив эти стартовые сектора на 512, мы узнаем начало каждого раздела в байтах. Для первого раздела это будет 4194304 байт и 62914560 доя второго . На самом деле эти данные нам не нужны, Linux вычислит их за нас.

На Raspberry Pi первый раздел обычно монтируется как `/boot`, а второй - как корневой раздел `/`. Что бы убедится в этом, нам необходимо создать две точки монтирования: `/mnt/root` и `/mnt/boot`:

    $ mkdir /mnt/root /mnt/boot
    $ chmod a=rwx /mnt/root /mnt/boot

Эти две команды нужно выполнить один раз. Далее, и при следующих случаях, когда мы будем с этим сталкиваться, следующие две команды подключают разделы нашего образа как виртуальные диски:

    $ mount -t vfat -o loop, offset=$((8192 * 512)) /BU/Rpi_8gb_backup.img /mnt/boot
    $ mount -t ext4 -o loop, offset=$((122880 * 512)) /BU/Rpi_8gb_backup.img /mnt/root

Эти команды создают пару точек монтирования (директории) и подключают первый раздел, из нашего образа, к '/mnt/boot' как файловую систему vfat, а второй к '/mnt/root' в файловой системе ext4.

Теперь, запустив файловый менеджер и посмотрев содержимое `/mnt/boot` и `/mnt/root`, вы должны увидеть множество файлов, как будто это на вашем Raspberry Pi.

Ну вот, теперь вы убедились в возможности восстановления данных из файла образа, и, в случае сбоя SD карты, сможете восстановить ее. Кроме того, файл образа подключен как виртуальный диск и вы можете работать с ним как с обычным диском: редактировать файлы, создавать новые, удалять ненужные и многое другое.


Редактирование файлов
---------------------
Предположим, что вам надо записать образ на другую SD карту, но до этого вы подключали ваш Raspberry Pi к телевизору через RCA разъём. Теперь же вы хотите подключить его посредством HDMI. Перед этим необходимо подредактировать файл config.txt в разделе /boot, внутри образа резервной копии.

Начальный раздел образа, обычно смонтирован как /boot, подключен на вашем компьютере к /mnt/boot. Используя ваш любимый редактор, откройте файл /mnt/boot/config.txt и установите значения hdmi_group=1 и hdmi_mode=1. Сохраните файл.

Теперь, когда вы запишете образ на новую карточку, ваш Raspberry Pi будет настроен для поключения к HDMI экрану.

Вы спросите, зачем все это? К примеру у вас есть несколько плат с идентичными настройками, но одна подключена к монитору либо телевизору в зале, а вторая, в детской. С помощью выше изложенного способа вы сможете, сделав резервную копию с одной SD карты, запускать другую плату с "неподходящим" дисплеем, просто изменив настройки дисплея на нужные.

Но имейте в виду, если у ваших Raspberry Pi статические сетевые настройки, то вам необходимо прописывать разные IP-адреса для них в файле /etc/network/interfaces (*в оригинале /etv - это ошибка. Ред.). Поскольку вы делаете копию образа, оба устройства будут иметь одинаковый IP-адрес, а это станет причиной сбоев в работе вашей компьютерной сети.

Восстановление отдельных файлов
-------------------------------
Следующий пример пригодится в том случае если вы ухитрились что-то удалить (конечно же случайно) на вашем Raspberry Pi, но вы не знаете что вмещает ваша резервная копия. Смонтируйте ваш образ как было описано в начале статьи. И если ваш Rasoberry Pi в сети, найдя файлы которые вам нужны, скопируйте их с помощью scp или sftp на Raspberry Pi. Для этого сделайте следующее:

    $ mount -t ext4 -o loop, offset=$((122880 * 512)) /BU/Rpi_8gb_backup.img /mnt/root
    $ cd /mnt/root/home/pi
    $ scp Lost_fi le. txt pi@raspberrypi:
После ввода пароля пользователя pi, файл будет копирован в домашнюю папку этого пользователя на вашем Rasberry Pi.

Итак, вы научились подключить и проверять образ резервной копии. И научились извлекать отдельные файлы для восстановления. Что же еще мы можем сделать?

Полное восстановление из резервной копии
----------------------------------------
Это так же просто, как инициализация SD карточки. Вы можете восстановить файл резервной копии на карту такого же либо большего размера. Как и прежде, следующая команда должна быть выполнена с правами root.

    $ dd if=Rpi_8gb_backup. img of=/dev/mmcblk0 bs=2M

Команда должа быть набрана в одной строке.

Восстановление займёт некоторое время. Всё что вам остаётся - подождать и загрузить Raspberry Pi со свежезаписанной карточки. Про восстановление сжатых и/или многотомных резервных копий см. I часть.


Восстановление на карту большего объема
---------------------------------------
Мы можем записать образ меньшего размера на карточку большего размера. Как-то мне пришлось проделать это, когда я восстанавливал SD карту на 8 Гб из 4 Гб образа. В результате я получил 4 Гб образ на 8 Гб карте. Чтобы задействовать "потерянные" 4 Гб, я запустил Pi с новой карточкой и вошел под своим логином как обычно.

После этого я выполнил `sudo raspi-config`, выбрал опцию *Expand root partition to fill SD card* и система расширила раздел 4 Гб чтобы заполнить оставшееся свободное пространство на карточке. Изменения вступили в силу только после перезагрузки.

Как вы заметили, не обязательно выполнять её с правами root.

    $ df -h /
    Fi lesystem Size Used Avai l Use% Mounted on
    /dev/root 7. 3G 1. 6G 5. 4G 23% /

Этот листинг показывает инфомрацию о моей корневой файловой системе с точкой `/`, теперь она стала 7.3 Гб, хоть восстанавливал я 4 Гб образ.
