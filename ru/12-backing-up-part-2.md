Резервное копирование - Часть II
================================

Norman Dunbar

Уровень сложности: Средний.


* * *

В первой части я рассказывал, как сделать резервную копию SD карты вашего Raspberry Pi. Во второй части я продемонстрирую как проверить работоспособность резервной копии. Так же я покажу вам "хитрость", с помощью которой вы сможете работать с образом резервной копии, как с обычным диском. Вы узнаете как редактировать файлы прямо в образе резервной копии. И когда, в дальнейшем, вы запишите образ на SD карту, все сделанные изменения останутся.

Напомню, что все это легко выполнимо в Linux,однако для пользователей Windows всё не так просто. Пользователям Windows следует подумать о Live CD с Linux или об установке Linux на виртуальную машину, например VirtualBox.


Проверка целостности резервной копии
------------------------------------
Сделать резервную копию - несложная задача, но важно убедиться, что данные переписались правильно. Будет не весело, когда SD карта в Raspberry Pi испортилась, а резервная копия оказалась нерабочей. Прийдется устанавливать и настраивать систему и все программы заново. И конечно же, данные будут потеряны безвозвратно. Так что, проверять резервный копии - это очень важно.

Самый простой способ - записать образ на другую SD карту и попробовать её в Raspberry Pi. Это быстро, просто, и мы так уже делали - см. часть I в предыдущем выпуске журнала.

В это статье описан способ, который позволит вам работать с образом, как с обычным устройством, например с SD картой.

Учтите, что все описанное дальше подразумевает,что образ разархивирован и находится на локальном жестком диске. Если ваш образ сжатый, распакуйте его и начнем.

Итак, первое что нужно сделать, это определить начало раздела. Потому как у нас есть образ SD карты, мы можем просмотреть его содержимое, и увидеть таблицу разделов.

Если хотите, можете выполнять все действия от пользователя Pi, тогда начинайте каждую команду c 'sudo'. Но, можно сделать проще, и получить root права командой:

    $ sudo sh

Эта команда запустить оболочку пользователя root и избавит вас от необходимости каждый раз водить sudo перед командами.

Первым делом нам нужно определить границы логических дисков, сохранённых в образе резервной копии и размер секторов. Для этого воспользуйтесь программой Fdisk:

    $ fdisk Rpi_8gb_backup.img

После этого вам нужно ввести команду `p`, чтобы напечатать таблицу разделов: количество, расположение и размеры.
Вывод будет примерно таким:

    Welcome to fdisk (util-linux 2.21.2).
    ...
    Command (m for help): p
    Disk Rpi_8gb_backup.img: 7948 MB, 7948206080 bytes
    255 heads, 63 sectors/track, 966 cylinders, total 15523840 sectors
    Units = sectors of 1 * 512 = 512 bytes
    Sector size (logical/physical): 512 bytes / 512 bytes
    I/O size (minimum/optimal): 512 bytes / 512 bytes
    Disk identifier: 0x000dbfc6
    Device Boot Start End Blocks Id System
    /BU/Rpi_8gb_backup. img1 8192 122879 57344 c W95 FAT32 (LBA)
    /BU/Rpi_8gb_backup. img2 122880 15523839 7700480 83 Linux

Из строчки `Units = sectors of 1 * 512 = 512 bytes` мы узнаём размер сектора - 512 байт.

В конце мы видим два раздела, начинающиеся с секторов 8192 и 122880.

    /BU/Rpi_8gb_backup. img1 8192 122879 57344 c W95 FAT32 (LBA)
    /BU/Rpi_8gb_backup. img2 122880 15523839 7700480 83 Linux

Умножив эти числа на 512 (размер сектора) мы получим смещение каждого раздела в байтах, это будет 4194304 и 62914560 байт для первого и второго соответственно. На самом деле эти числа нам не понадобятся, Linux вычислит их за нас.

На Raspberry Pi первый раздел обычно монтируется как `/boot`, а второй - как корневой раздел `/`. Нам тоже понадобится два каталога: `/mnt/root` и `/mnt/boot`:

    $ mkdir /mnt/root /mnt/boot
    $ chmod a=rwx /mnt/root /mnt/boot

Эти две команды нужно выполнить один раз.

Сейчас и далее, чтобы примонтировать два раздела из резеврной копии в "виртуальный диск", нужно будет выполнить:

    $ mount -t vfat -o loop, offset=$((8192 * 512)) /BU/Rpi_8gb_backup.img /mnt/boot
    $ mount -t ext4 -o loop, offset=$((122880 * 512)) /BU/Rpi_8gb_backup.img /mnt/root

В результате первый раздел с файловой системой `vfat` будет подмонтирован в `/mnt/boot`, а второй раздел ext4 - в `/mnt/root`.

Теперь можно открыть файловый менеджер и посмотреть содержимое `/mnt/boot` и `/mnt/root` - вы должны увидеть множество файлов, точно как если бы видели их из Raspberry Pi.

Если всё получилось, то мы можем быть уверены, что файл образа рабочий. Кроме того, теперь файл образа работает как настоящяя флешка, и мы можем работать с ним как с настоящим диском: редактировать файлы, создавать новые, удалять ненужные - и так далее.


Редактирование файлов
---------------------
Когда может понадобиться изменять файлы внутри образа резервной копии? Например, у вас есть два Raspberry Pi с одинаковыми настройками, но один подключен через RCA к телевизору, а второй - через HDMI к монитору компьютера.

Предположим, вы сняли резервную копию карты памяти Raspberry Pi с RCA подключением, и вам нужно записать образ для Pi с HDMI. Но сначала придётся отредактировать `config.txt` в `/boot` внутри образа.

Так как `/boot` - это первый раздел образа и примонтирован на компьютере как `/mnt/boot`, то мы можем просто открыть и изменить `/mnt/boot/config.txt` в любом текстовом редакторе:

    hdmi_group = 1
    hdmi_mode  = 1

После того как вы запишете образ на SD карту, Raspberry Pi будет работать с HDMI. Теперь для вас нет необходимости держать две почти одинаковые резервные копии, можно пользоваться одной, при необходимости меняя настройки в `config.txt` описанным выше способом.

Примечание: если ваши Raspberry Pi настроены на работу со статическими IP адресами, не забудьте вносить поправки `/etc/metwork/interfaces`.


Восстановление отдельных файлов
-------------------------------
Монтирование образа диска может оказаться полезным тогда, когда нужно восстановить один или несколько (но не все сразу) файлов из резервной копии. Подключите резервную копию точно так же, как мы делали в предыдущем случае.

Если Raspberry Pi подключен к сети, вы можете скопировать на него эти файлы, например через SCP или FTP.

    $ mount -t ext4 -o loop, offset=$((122880 *
    512)) /BU/Rpi_8gb_backup. img /mnt/root
    $ cd /mnt/root/home/pi
    $ scp Lost_fi le. txt pi@raspberrypi :

После того, как вы введёте пароль от Pi, файл будет скопирован в домашнюю папку пользователя.

Итак, теперь мы умеем подключать файл резервной копии как обыкновенный диск, проверять его целостность и копировать из резервнйо копии отдельные файлы. Что ещё можно сделать?


Полное восстановление из резервной копии
----------------------------------------
Это так же просто, как инициализация SD карточки. Вы можете восстановить файл резервной копии на карту такого же размера (или больше). Как и прежде, следующая команда должна быть выполнена из-под root.

    $ dd if=Rpi_8gb_backup. img of=/dev/mmcblk0 bs=2M

Восстановление займёт некоторое время. Всё что вам остаётся - подождать и загрузить Raspberry Pi со свежезаписанной карточки. Про восстановление сжатых и/или многотомных резервных копий см. I часть.


Восстановление на карту большего объёма
---------------------------------------
У нас есть возможность записать файл из образа меньшего размера на более объёмную SD карту, в ходе обновления например. Мне пришлось проделать это когда я восстанавливал SD карту на 8 Гб из 4 Гб образа.

После окончания операции я получил 4 Гб образ на 8 Гб карте.

Чтобы задействовать "лишние" 4 Гб, мне пришлось загрузиться в Pi с новой карточкой и войти под своим ползователем как обычно.

После этого я выполнил `sudo raspi-config`, выбрал опцию *Expand root partition to fill SD card* и система расширила раздел 4 Гб чтобы заполнить оставшееся свободное пространство на карточке. Изменения вступили в силу только после перезагрузки.

Как вы заметили, не обязательно выполнять её с правами root.

    $ df -h /
    Fi lesystem Size Used Avai l Use% Mounted on
    /dev/root 7. 3G 1. 6G 5. 4G 23% /

Этот листинг показывает инфомрацию о моей корневой файловой системе с точкой `/`, теперь она стала 7.3 Гб, хоть восстанавливал я 4 Гб образ.
