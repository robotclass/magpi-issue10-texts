Резервное копирование - Часть II
================================

Norman Dunbar

Уровень сложности: Средний.


* * *

В первой части я рассказывал, как сделать резервную копию SD карты вашего Raspberry Pi. Сегодня же вы узнаете:

- как проверить целостность резервной копии;
- несколько хитростей, чтобы работать с образом флеш-карты, как с настоящим диском;
- как редактировать файлы прямо в файле резервной копии.

Напомню, что все описанные в статье действия легко произвести в Linux, для пользователей Windows всё будет гораздо сложнее. Если вам не повезло, возможно следует подумать о Live CD с Linux или об установке Linux на виртуальную машину, например VirtualBox.


Проверка целостности резервной копии
------------------------------------
Сделать резервную копию - несложная задача, но важно убедиться что данные перепсиались правильно. Беда, когда SD карточка полетела, а резервная копия оказалась нерабочей - устанавливать и настраивать всю систему и программы придётся с нуля. И конечно же, данные будут потеряны безвозвратно...

Итак, проверять резервные копии - жизненно важная задача.

Самый простой способ - записать образ на другую SD карту, а потом попробовать её в Raspberry Pi. Это быстро, просто, и мы так уже делали - см. часть I в предыдущем выпуске журнала.

Сейчас мы рассмотрим метод, который позволяет работать с образом диска, как будто бы он был настоящей картой памяти.

Примечание: дальнейшие инструкции предполагают, что образ несжатый и находится на вашем жёстком диске. Если образ упакованный, вам придётся распаковать его.

Нам понадобятся права пользователя root. Вы можете начинать каждую команду со слов `sudo ...`, но можно упроситить себе жизнь и открыть командную оболочку root один раз:

    $ sudo sh

Первым делом нам нужно определить границы логических дисков, сохранённых в образе резервной копии и размер секторов. Для этого воспользуйтесь программой Fdisk:

    $ fdisk Rpi_8gb_backup.img

После этого вам нужно ввести команду `p`, чтобы напечатать таблицу разделов: количество, расположение и размеры.
Вывод будет примерно таким:

    Welcome to fdisk (util-linux 2.21.2).
    ...
    Command (m for help): p
    Disk Rpi_8gb_backup.img: 7948 MB, 7948206080 bytes
    255 heads, 63 sectors/track, 966 cylinders, total 15523840 sectors
    Units = sectors of 1 * 512 = 512 bytes
    Sector size (logical/physical): 512 bytes / 512 bytes
    I/O size (minimum/optimal): 512 bytes / 512 bytes
    Disk identifier: 0x000dbfc6
    Device Boot Start End Blocks Id System
    /BU/Rpi_8gb_backup. img1 8192 122879 57344 c W95 FAT32 (LBA)
    /BU/Rpi_8gb_backup. img2 122880 15523839 7700480 83 Linux

Из строчки `Units = sectors of 1 * 512 = 512 bytes` мы узнаём *размер сектора*, 512 байт.

В конце мы видим два раздела, начинающиеся с секторов 8192 и 122880.

    /BU/Rpi_8gb_backup. img1 8192 122879 57344 c W95 FAT32 (LBA)
    /BU/Rpi_8gb_backup. img2 122880 15523839 7700480 83 Linux

Умножив эти числа на 512 (размер сектора) мы получим смещение каждого раздела в байтах, это будет 4194304 и 62914560 байт для первого и второго соответственно. На самом деле нам эти числа в байтах не понадобятся, Linux может посчитать их за нас.

На Raspberry Pi первый раздел обычно монтируется как `/boot`, а второй - как корневой раздел `/`.

Далее, нам нужно создать два каталога: `/mnt/root` и `/mnt/boot`:

    $ mkdir /mnt/root /mnt/boot
    $ chmod a=rwx /mnt/root /mnt/boot

Эти две команды нужно выполнить один раз.

Сейчас и далее, чтобы примонтировать два раздела из резеврной копии в "виртуальный диск", нужно будет выполнить:

    $ mount -t vfat -o loop, offset=$((8192 * 512)) /BU/Rpi_8gb_backup.img /mnt/boot
    $ mount -t ext4 -o loop, offset=$((122880 * 512)) /BU/Rpi_8gb_backup.img /mnt/root

В результате первый раздел с файловой системой `vfat` будет подмонтирован в `/mnt/boot`, а второй раздел ext4 - в `/mnt/root`.

Теперь можно открыть файловый менеджер и посмотреть содержимое `/mnt/boot` и `/mnt/root` - вы должны увидеть множество файлов, точно как если бы видели их из Raspberry Pi.

Если всё получилось, то мы можем быть уверены, что файл образа рабочий. Кроме того, теперь файл образа работает как настоящяя флешка, и мы можем работать с ним как с настоящим диском: редактировать файлы, создавать новые, удалять ненужные - и так далее.


Редактирование файлов
---------------------
Предположим, вам нужно залить образ на SD карту, но вместо RCA будете использовать HDMI подключение. Но прежде, вам нужно отредактировать файл `config.txt` в каталоге `/boot` внутри образа.

Так как первый раздел образа, тот что в Raspberry Pi значится как `/boot`, примонтирован на компьютере как `/mnt/boot`, то всё что остаётся сделать, это поправить `/mnt/boot/config.txt` вашим любимым текстовым редактором:

    hdmi_group = 1
    hdmi_mode  = 1

После того как вы запишете образ на SD карту, RPi будет работать с HDMI.

Зачем это может пригодиться? Ну, например если у вас несколько RPi с одинаковыми настройками, но один подключен к HDMI TV, а другой - к VGA. Такое редактирование файлов позволит вам хранить только копию карты с одного устройства, а для другого останется просто "поправить дисплей".

Естественно, не забудьте отредактировать `/etc/metwork/interfaces` если ваши RPi настроены со статическим IP адресом.


Восстановление одиночного файла
-------------------------------
Следующий метод, монтирование образа дискакак устройства, полезен тогда, когда вы случайно удалили файл на Pi, но вы знаете что есть резервная копия. Если Pi подключен к сети, вы можете просто примонтировать образ диска как мы делали раньше, найти нужный файл и скопировать его на Pi через SCP или FTP:

    $ mount -t ext4 -o loop, offset=$((122880 *
    512)) /BU/Rpi_8gb_backup. img /mnt/root
    $ cd /mnt/root/home/pi
    $ scp Lost_fi le. txt pi@raspberrypi :

После того, как вы введёте пароль от Pi, файл будет скопирован в домашнюю папку пользователя.

Итак, теперь вы знаете как примонтировать файл с резервной копии на компьютере, убедиться в его целостности, и как бонус, извлекать файл(ы) для частичного восстановления. Что ещё мы можем сделать?

Полное восстановление из резервной копии
----------------------------------------
Это так же просто, как инициализация SD карточки в первый раз. Вы можете восстановить файл резервной копии на карту такого же размера (или больше). Как и прежде, следующая команда должна быть выполнена из-под root.

    $ dd if=Rpi_8gb_backup. img of=/dev/mmcblk0 bs=2M

Восстановление займёт некоторое время. Всё что вам остаётся - подождать и загрузить Pi со свежезаписанной карточки. Про восстановление сжатых и/или многотомных резервных копий см. I часть.

Восстановление на карту большего объёма
---------------------------------------
У нас есть возможность записать файл из образа меньшего размера на более объёмную SD карту, в ходе обновления например. Мне пришлось проделать это когда я восстанавливал SD карту на 8 Гб из 4 Гб образа.

После окончания операции я получил 4 Гб образ на 8 Гб карте.

Чтобы задействовать "лишние" 4 Гб, мне пришлось загрузиться в Pi с новой карточкой и войти под своим ползователем как обычно.

После этого я выполнил `sudo raspi-config`, выбрал опцию *Expand root partition to fill SD card* и система с удовольствием расширила раздел в 4 Гб чтобы заполнить оставшееся свободное пространство на карточке. Изменения вступили в силу при перезагрузке, они не происходят немедленно.

Как вы заметили, не обязательно выполнять её с правами root.

    $ df -h /
    Fi lesystem Size Used Avai l Use% Mounted on
    /dev/root 7. 3G 1. 6G 5. 4G 23% /

Этот листинг показывает инфомрацию о моей корневой файловой системе с точкой `/`, теперь она стала 7.3 Гб, хоть восстанавливал я 4 Гб образ.
