WebIOPi - REST-фреймворк для Raspberry Pi
=========================================

Роботизированная камера с удалённым управлением, Часть II

Eric PTAK
Guest Writer

Уровень сложности: Продвинутый


Построение интерфейса
---------------------
Создание собственного интерфейса - несложная задача, и мы решим её с помощью HTML и JavaScript. Чтобы использовать возможности WebIOPi, достаточно включить файл `webiopi.js` в документ HTML. Создайте новый файл `index.html` рядом со сценарием Python:

    <html>
      <head>
      <title>CamBot</title>
      <script type="text/javascript" src="/webiopi.js"></script>
      <script type="text/javascript">
        // Здесь будет код Javascript
      </script>
      </head>
      <body>
        <div id="box" align="center">
        </div>
      </body>
    </html>

Обратите внимание на начальный слэш при подключении `webiopi.js`, он указывает на то, что файл нужно искать в корне сервера - иначе он может быть не найден. Я добавил пустую секцию `script`, в ней мы запишем вызовы к библиотеке WebIOPi. И создаем контейнер `div`, в котором разместим элементы управления.

В секции `script` создаем функцию `init()` для создания интерфейса с помощью WebIOPi. Библиотека WebIOPi содержит много функций для легкого создания кнопок управления GPIO. Здесь мы используем обычную кнопку для вызова разных функций при нажатии и отпускании кнопки. Каждая функция вызывает свою последовательность команд на сервере. Не забудьте зарегистрировать функцию `init()` в WebIOPi. Она будет выполнена как только всё загрузится и будет готово.

    function init() {
      var button =
      webiopi().createButton(
        "bt_up" ,    // идентификатор
        "/\\" ,      // надпись
        go_forward,  // обработчик нажатия
        stop);       // обработчик отпускания
        $("#box" ).append(button);
}

Не забывайте что `webiopi()` - это функция и зарезервированное слово, поэтому нужно записывать скобки, что б она смогла вернуть объект WebIOPi. Также функцию `webiopi()` можно вызывать `w()`.

Ну и теперь запустим сервер и опробуем интерфейс. Откройте терминал в том каталоге, где вы создали сценария Python и HTML файл, и выполните команду:

    $ sudo python вашскрипт.py



Трансляция видео с веб-камеры
-----------------------------
Есть много способов передачи видео, выбор каждый раз зависит от модели камеры. В моём случае была новая веб-камера, которая поддерживает как необработанный RAW вывод, так и MJPG разрешением до 1280x720@30fps.

Во-первых, проверьте, что камера установленна и опознана. Наберите в терминале:

    $ lsusb
    [...]
    Bus 001 Device 005: ID 046d: 0825
    Logitech, Inc. Webcam C270
    $ ls /dev/video*
    /dev/video0

Затем, убедитесь что она работает. Вы можете установить uvccapture с помощью apt-get или aptitude, а потом сделать одиночный снимок:

    $ uvccapture -v
    Using videodevice: /dev/video0
    Saving images to: snap.jpg
    Image size: 320x240
    Taking snapshot every 0 seconds
    Taking images using mmap
    Resetting camera settings
    Camera brightness level is 0
    Camera contrast level is 255
    Camera saturation level is 255
    Camera gain level is 255
    Saving image to: snap.jpg

Если uvccapture завершиалсь без ошибок, мы можем приступить к передаче видеопотока с камеры.

Я использую MJPG-STREAMER, он очень простой в использовании. Он позволяет напрямую транслировать видео MJPEG 320x240@25fps с веб-камеры по HTTP. Я пробовал FFMPEG, но он работает с необработанным RAW выводом камеры, а затем кодирует его в MJPEG с частотой кадров около 5fps.

Вы можете загрузить MJPG-STREAMER по адресу http://sourceforge.net/projects/mjpg-streamer/

Вам также понадобится `libjpeg8-dev`, который можно установить через aptitude/apt-get.

Распакуйте и соберите MJPG-STREAMER командой make, потом запустите:

    $ ./mjpg_streamer -i "./input_uvc.so –r 320x240 –f 25" -o "./output_http.so –n –p 8001" &

Вернитесь в файл HTML и добавьте тег `img` с атрибутом `src` равным `http://raspberrypi:8001/?action=stream`, заменив `raspberrypi` на IP адрес вашего Pi. Как вариант, можно попробовать набрать адрес прямо в браузере.

        ...
        <img src="http://raspberrypi:8001/?action=stream"/>
      </body>
    </html>

Заключение
----------
В этой статье вы узнали, как установить библиотеку WebIOPi и как использовать её совместно с вашими скриптами Python для создания макропоследовательностей, которые можно запускать из веб-странички.

Приведённый код неполный, и показывает как роботу двигаться вперёд и останавливаться. Чтобы он мог двигаться во всех направлениях, добавьте функции `left/right_backward`, `turn_left/right` и `go_backward` самостоятельно.

Полный код можно загрузить по адресу http://files.trouch.com/webiopi/cambot.zip. Больше примеров можно посмотреть на вики проекта и в папке examples архива с WebIOPi.

* * *

Eric PTAK, создатель WebIOPi

http://trouch.com

http://code.google.com/p/webiopi/


Примечание:
Часть I этого руководства была в послденем выпуске MagPi. Пожалуйста, прочитайте этот выпуск прежде чем приступать к описанным здесь действиям. Вы можете скачать его на сайте www.themagpi.com.
